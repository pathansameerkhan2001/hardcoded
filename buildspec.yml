version: 0.2

phases:
  install:
    commands:
      - echo "ğŸ”§ Starting INSTALL phase..."
      - echo "â¡ï¸ Downloading Gitleaks tar.gz..."
      - curl -sSL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_Linux_x86_64.tar.gz -o gitleaks.tar.gz
      - echo "ğŸ“¦ Extracting..."
      - tar -xzf gitleaks.tar.gz
      - chmod +x gitleaks
      - echo "ğŸ“‚ Verifying file exists:"
      - ls -lah gitleaks
      - echo "ğŸ” Checking version..."
      - ./gitleaks version
      - echo "âœ… INSTALL phase complete."

  build:
    commands:
      - echo "ğŸš€ Starting BUILD phase Running Gitleaks scan..."
      - ./gitleaks detect --source . --report-format json --report-path gitleaks-report.json
      - echo "ğŸ“„ Gitleaks scan complete. Checking for secrets..."
      - |
        if grep -q '"StartLine":' gitleaks-report.json; then
          echo "âŒ Secrets detected in the source code!"
          echo "ğŸ›‘ Failing the build due to secret leakage."
          exit 1
        else
          echo "âœ… No secrets found in the code. Build can proceed."
        fi
      - echo "ğŸ BUILD phase complete."

artifacts:
  files:
    - gitleaks-report.json


